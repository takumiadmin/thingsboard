name: Build & Push tb-node (lts-4.2)

on:
  push:
    branches: [ "lts-4.2" ]
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 90
    env:
      # Keep memory under control on GitHub runners
      NODE_OPTIONS: --max-old-space-size=2048
      MAVEN_OPTS: -Xmx2048m -XX:+UseParallelGC
      # Make Maven quieter & faster
      MAVEN_ARGS: -DskipTests -Dlicense.skip=true -Dmaven.javadoc.skip=true -Dmaven.source.skip=true -Dskip-web=true -T 1C
      # Tell Docker buildx to use GHA cache
      DOCKER_BUILDKIT: "1"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: none

      - name: Set up Node 18 + Yarn
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: yarn
          cache-dependency-path: ui-ngx/yarn.lock

      - name: Keepalive (prevent 10-min log silence)
        run: |
          ( while true; do echo "ðŸŸ¢ build keepalive $(date -u)"; sleep 55; done ) &
          echo $! > keepalive.pid
      - name: Free up space on runner
        run: |
          echo "ðŸ§¹ Cleaning disk space..."
          sudo rm -rf /opt/hostedtoolcache/* || true
          sudo rm -rf /usr/share/dotnet || true
          sudo rm -rf /usr/local/lib/android || true
          sudo rm -rf /usr/local/share/boost || true
          sudo rm -rf "$AGENT_TOOLSDIRECTORY" || true
          sudo apt-get clean
          sudo docker system prune -af || true
          df -h

      - name: Build UI and Backend
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y npm
          npm install --global yarn

          echo "=== Building UI (Angular) ==="
          cd ui-ngx
          yarn install --frozen-lockfile
          # prod build emits into target/generated-resources/public for TB 4.2.x
          yarn build:prod
          cd ..
          echo "Cleaning node_modules to free space..."
          sudo rm -rf ui-ngx/node_modules || true
          df -h

          echo "=== Building backend (Maven) ==="
          mvn clean package $MAVEN_ARGS

          echo "Artifacts in application/target:"
          ls -lh application/target | sed -n '1,80p'

      - name: Prepare Docker context
        shell: bash
        run: |
          set -euo pipefail

          JAR_FILE=$(ls application/target/thingsboard-*-boot.jar | head -n1)
          echo "Detected JAR: $JAR_FILE"

          UI_PATH="ui-ngx/target/generated-resources/public"
          if [ ! -d "$UI_PATH" ]; then
            echo "âŒ UI build not found at $UI_PATH"
            kill $(cat keepalive.pid) || true
            exit 1
          fi
          echo "âœ… Using UI from: $UI_PATH"

          # Minimal context, no giant listings
          rm -rf docker-build
          mkdir -p docker-build/ui
          cp -r "$UI_PATH"/* docker-build/ui/
          cp "$JAR_FILE" docker-build/thingsboard.jar

          cat > docker-build/Dockerfile <<'EOF'
          FROM thingsboard/tb-postgres:4.2.1
          # Replace backend JAR and UI. Do NOT chmod read-only files.
          COPY thingsboard.jar /usr/share/thingsboard/bin/thingsboard.jar
          COPY ui/ /usr/share/thingsboard/ui/
          RUN echo "âœ… Custom TB build - patched backend & UI"
          ENTRYPOINT ["/usr/share/thingsboard/bin/docker-entrypoint.sh"]
          EOF

          echo "Docker context size:"
          du -sh docker-build || true

      - name: Stop keepalive (pre-docker)
        run: |
          kill $(cat keepalive.pid) || true

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GHCR_PAT }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Retry wrapper for network flakes during build/push
      - name: Build & Push Docker image (with cache + retry)
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 40
          max_attempts: 3
          command: |
            docker buildx build \
              --progress=plain \
              --pull \
              --no-cache \
              --provenance=false \
              --sbom=false \
              --cache-from=type=gha \
              --cache-to=type=gha,mode=max \
              --platform linux/amd64 \
              -t ghcr.io/${{ github.repository_owner }}/tb-node:latest \
              -t ghcr.io/${{ github.repository_owner }}/tb-node:lts-4.2 \
              --push \
              docker-build
