name: Build & Push tb-node (lts-4.2)

on:
  push:
    branches: [ "lts-4.2" ]
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 90
    env:
      NODE_OPTIONS: --max-old-space-size=2048
      MAVEN_OPTS: -Xmx2048m -XX:+UseParallelGC
      MAVEN_ARGS: -DskipTests -Dlicense.skip=true -Dmaven.javadoc.skip=true -Dmaven.source.skip=true -Dskip-web=true -T 1C
      DOCKER_BUILDKIT: "1"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      #####################################################################
      # âœ… STEP 1: Install Java and Maven manually â€” guaranteed in PATH
      #####################################################################
      - name: Install Java 17 + Maven
        run: |
          sudo apt-get update -y
          sudo apt-get install -y openjdk-17-jdk maven
          sudo update-alternatives --set java /usr/lib/jvm/java-17-openjdk-amd64/bin/java
          sudo update-alternatives --set javac /usr/lib/jvm/java-17-openjdk-amd64/bin/javac
          export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
          echo "JAVA_HOME=$JAVA_HOME" >> $GITHUB_ENV
          echo "$JAVA_HOME/bin" >> $GITHUB_PATH
          java -version
          mvn -version

      #####################################################################
      # âœ… STEP 2: Set up Node + Yarn
      #####################################################################
      - name: Set up Node 18 + Yarn
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: yarn
          cache-dependency-path: ui-ngx/yarn.lock

      #####################################################################
      # âœ… STEP 3: Keepalive + cleanup
      #####################################################################
      - name: Keepalive (prevent 10-min log silence)
        run: |
          ( while true; do echo "ðŸŸ¢ build keepalive $(date -u)"; sleep 55; done ) &
          echo $! > keepalive.pid

      - name: Free up space on runner
        run: |
          echo "ðŸ§¹ Cleaning disk space..."
          sudo rm -rf /opt/hostedtoolcache/* /usr/share/dotnet /usr/local/lib/android /usr/local/share/boost || true
          sudo apt-get clean
          sudo docker system prune -af || true
          df -h

      #####################################################################
      # âœ… STEP 4: Build UI and backend
      #####################################################################
      - name: Build UI and Backend
        shell: bash
        run: |
          set -euo pipefail
          echo "=== Building UI (Angular) ==="
          cd ui-ngx
          yarn install --frozen-lockfile
          yarn build:prod
          cd ..
          echo "Cleaning node_modules to free space..."
          sudo rm -rf ui-ngx/node_modules || true
          df -h

          echo "=== Building backend (Maven) ==="
          mvn clean package $MAVEN_ARGS

          echo "Artifacts in application/target:"
          ls -lh application/target | sed -n '1,80p'

      #####################################################################
      # âœ… STEP 5: Prepare Docker context
      #####################################################################
      - name: Prepare Docker context
        shell: bash
        run: |
          set -euo pipefail

          JAR_FILE=$(ls application/target/thingsboard-*-boot.jar | head -n1)
          echo "Detected JAR: $JAR_FILE"

          UI_PATH="ui-ngx/target/generated-resources/public"
          if [ ! -d "$UI_PATH" ]; then
            echo "âŒ UI build not found at $UI_PATH"
            kill $(cat keepalive.pid) || true
            exit 1
          fi
          echo "âœ… Using UI from: $UI_PATH"

          rm -rf docker-build
          mkdir -p docker-build/ui
          cp -r "$UI_PATH"/* docker-build/ui/
          cp "$JAR_FILE" docker-build/thingsboard.jar

          cat > docker-build/Dockerfile <<'EOF'
          FROM thingsboard/tb-node:4.2.1
          # Replace backend JAR and UI
          COPY thingsboard.jar /usr/share/thingsboard/bin/thingsboard.jar
          COPY ui/ /usr/share/thingsboard/ui/
          RUN echo "âœ… Custom TB build - patched backend & UI"
          # Start ThingsBoard manually (no entrypoint script in tb-node 4.2.1)
          CMD ["java", "-jar", "/usr/share/thingsboard/bin/thingsboard.jar"]
          EOF


          echo "Docker context size:"
          du -sh docker-build || true

      #####################################################################
      # âœ… STEP 6: Stop keepalive + push to GHCR
      #####################################################################
      - name: Stop keepalive (pre-docker)
        run: |
          kill $(cat keepalive.pid) || true

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GHCR_PAT }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build & Push Docker image (with cache + retry)
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 40
          max_attempts: 3
          command: |
            docker buildx build \
              --progress=plain \
              --pull \
              --no-cache \
              --provenance=false \
              --sbom=false \
              --cache-from=type=gha \
              --cache-to=type=gha,mode=max \
              --platform linux/amd64 \
              -t ghcr.io/${{ github.repository_owner }}/tb-node:latest \
              -t ghcr.io/${{ github.repository_owner }}/tb-node:lts-4.2 \
              --push \
              docker-build
      - name: Wait for image to be available
        run: sleep 30
      - name: Deploy to EC2
        uses: appleboy/ssh-action@master
        with:
          host: 3.109.229.211
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script_stop: true
          command_timeout: 30m
          script: |
            echo "ðŸš€ Pulling latest image from GHCR and redeploying..."
            cd /opt/thingsboard
            sudo docker compose pull
            sudo docker compose up -d
            sudo docker image prune -f
            echo "âœ… Deployment completed successfully!"



